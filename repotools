#!/bin/bash

# Load the configuration file

if [ ! -f .config ]; then
  echo "Config file not found."
  exit 1
fi

source .config

# ----------



# Help&usage

function print_help() {
  echo
}

function print_usage() {
  echo
}

# ----------



# Commands

function new_repository() {
  local NAME="$1"; shift

  cd "${GLOBAL_REPO_DIR}"

  if [[ -d "${NAME}" ]]; then
    echo "The repository already exists."
  else
    git clone --depth 1 https://github.com/cezarmathe/example_repository.git "${NAME}"

    # TODO: change config file to match the repo name and other config variables
  fi
  
}

function initialize_build_environment() {
  local DIR="$1"; shift

  if [[ -z "${DIR}" ]]; then
    mkdir -p "${GLOBAL_BUILD_DIR}"
    mkarchroot -C /etc/pacman.conf "${GLOBAL_BUILD_DIR}/root" base-devel
  else
    if [[ "${DIR:0:1}" = "/" ]]; then
      mkdir -p "${DIR}"
      mkarchroot -C /etc/pacman.conf "${DIR}/root" base-devel
    else
      mkdir -p "${REPOTOOLS_PATH}/${DIR}"
      mkarchroot -C /etc/pacman.conf "${REPOTOOLS_PATH}/${DIR}}/root" base-devel
    fi
  fi
}

function sync_with_remote() {
  local REPO_NAME="$1"; shift

  if [[ ! -z "${REPO_NAME}" ]]; then
    # sync a single repository
    cd "${GLOBAL_REPO_DIR}"
    if [[ ! -d "${REPO_NAME}" ]]; then
      echo "Repository ${REPO_NAME} does not exist."
    else
      cd "${REPO_NAME}"

      if [[ ! -f ".config" ]]; then
        echo "The repository ${REPO_NAME} has no config file."
      else
        source ./.config

        if [[ ! -z "${LOCAL_REMOTE_GIT_ADDRESS}" ]]; then
          echo "The repository ${REPO_NAME} does not have a remote git address configured."
          return
        fi

        git remote update

        git commit -a -m "$(date)"

        local UPSTREAM=${1:-'@{u}'}
        local LOCAL=$(git rev-parse @)
        local REMOTE=$(git rev-parse "$UPSTREAM")
        local BASE=$(git merge-base @ "$UPSTREAM")

        if [ $LOCAL = $REMOTE ]; then
            echo "The repository ${REPO_NAME} is up to date."
        elif [ $LOCAL = $BASE ]; then
            echo "${REPO_NAME} is not up to date with the remote, pulling the changes.."
            git pull 

        elif [ $REMOTE = $BASE ]; then
            echo "${REPO_NAME} is ahead of the remote, pushing the changes.."            
            git push 
        else
            echo "${REPO_NAME} and the remote are diverged."
        fi
      fi
    fi
  else
    echo "Syncing all repositories."
    for reponame in "${GLOBAL_REPO_DIR}/*"; do
      bash "${REPOTOOLS_PATH}/repotools" -S "${reponame}"
    done 
  fi
}

function build_packages() {
  local PACKAGE_NAME="$1"; shift

  if [[ ! -z "${REPO_NAME}" ]]; then

  else

  fi
}

# ----------



# Main cli

function main() {

  while getopts 'n:a:r:sSbB:ucm:iI:' flag; do
    case "${flag}" in
      n)
        # new repository
        new_repo_flag=1
        new_repo_name="${OPTARG}"
        # new_repository "${OPTARG}"
        ;;
      a)
        # add a new package in the repository
        ;;
      r)
        # remove the package from the repository
        ;;
      s)
        # sync all the repositories with the remote
        sync_flag=1
        ;;
      S)
        # sync a repository with the remote
        Sync_flag=1
        ;;
      u)
        # update the packages in the repository
        ;;
      c)
        # do a cycle
        ;;
      b)
        # build all packages in a repository
        ;;
      B)
        # build a package in a repository
        ;;
      m)
        # create a new meta package in the repository
        ;;
      i)
        # initialize the build environment
        initialize_build_environment 
        ;;
      I)
        # initialize the build environment in a specific directory
        initialize_build_environment "${OPTARG}"
        ;;
      *)
        print_usage
        exit 1 ;;
    esac
  done

  # move functions here and use a single repository name ($1)

  if [[ ! -z "${new_repo_flag}" ]]; then
    new_repository "${new_repo_name}"
  fi

  if [[ ! -z "sync_flag" ]]; then
    sync_with_remote
  fi

  # first add functions that do not depend on a repository name
  # initialize_build_environment, sync_with_remote(for all repositories)
  # (also cycle)

  local REPO="$1"; shift

  if [[ -z "${REPO}" ]]; then
    echo "No repository name specified."
    exit 1
  fi

  if [[ ! -z "Sync_flag" ]]; then
    sync_with_remote "${REPO}"
  fi

  
}

main $@