#!/bin/bash


# Load the script files

if [[ ! -d "script_files" ]]; then
  echo "The folder with the script files could not be found."
  exit 1
fi

script_files=("script_files/.config" "script_files/add_remove_packages.sh" "script_files/build_environment.sh" "script_files/build_packages.sh" "script_files/help_usage.sh" "script_files/new_meta_package.sh" "script_files/new_repository.sh" "script_files/pacman_entries.sh" "script_files/sync_repositories.sh" "script_files/update_repositories.sh" "script_files/utils.sh")

for item in ${script_files[*]}; do
  if [ ! -f "${item}" ]; then
    echo "${item} file not found."
    exit 1
  fi
  source "${item}"
done

# ----------



# Main cli

function main() {

  # Add new package: -a <package_name> <repo_name> 
  # Build all packages from all repositories: -d
  # Build packages: -b <repo_name>; -B <package_name> <repo_name>
  # Cycle: -c
  # Generate pacman entry: -g; -G <repo_name>
  # Help&usage: -h 
  # Initialize build environment: -i; -I <directory>
  # New meta package: -m: <package_name> <repo_name>
  # New repository: -n <repo_name>; -N <repo_name>
  # Remove package: -r <package_name> <repo_name>
  # Sync repositories: -s; -S <repo_name>
  # Update repositories: -u; -U <repo_name>

  while getopts 'N:n:a:r:sSbB:guUcm:iI:' flag; do
    case "${flag}" in
      n)
        # new repository
        flag_new_repo=1
        arg_new_repo="${OPTARG}"
        shift 2;;
      N)
        # new repository which opens the config file in the editor
        flag_new_repo=1
        arg_new_repo="${OPTARG}"
        arg_open_config_in_editor=1
        shift 2;;
      a)
        # add a new package in the repository
        flag_add=1
        arg_add="${OPTARG}"
        shift 2;;
      r)
        # remove the package from the repository
        flag_remove=1
        arg_remove="${OPTARG}"
        shift 2;;
      s)
        # sync all the repositories with the remote
        flag_sync=1
        shift;;
      S)
        # sync a repository with the remote
        flag_Sync=1
        shift;;
      u)
        # update all packages in all repositories
        flag_update=1
        shift;;
      U)
        # update all packages in a certain repository
        flag_Update=1
        shift;; 
      c)
        # do a cycle
        flag_cycle=1
        shift;;
      b)
        # build all packages in a repository
        flag_build=1
        shift;;
      B)
        # build a package in a repository
        flag_build=1
        arg_build="${OPTARG}"
        shift 2;;
      g)
        # build all packages in all repositories
        flag_build_all=1
        shift;;
      m)
        # create a new meta package in the repository
        flag_new_meta_pkg=1
        arg_new_meta_pkg="${OPTARG}"
        shift 2;;
      i)
        # initialize the build environment
        flag_init_build_env=1
        shift;;
      I)
        # initialize the build environment in a specific directory
        flag_init_build_env=1
        arg_init_build_env="${OPTARG}"
        shift 2;;
      *)
        print_usage
        exit 1 
        ;;
    esac
  done

  # trap remove_tmp_files EXIT

  # flags that are completely independent
  if [[ ! -z "${flag_new_repo}" ]]; then
    new_repository "${arg_new_repo}"
  fi

  if [[ ! -z "${flag_init_build_env}" ]]; then
    initialize_build_environment "${arg_init_build_env}"
  fi

  # the cycle flag blocks other flags
  if [[ ! -z "${flag_cycle}" ]]; then
    # cycle
    exit
  fi

  # flags that do not depend on a repository name
  if [[ ! -z "${flag_sync}" ]]; then
    sync_with_remote
  fi

  if [[ ! -z "${flag_update}" ]]; then
    update_repository
    echo
  fi

  if [[ ! -z "${flag_build_all}" ]]; then
    build_all_packages
  fi

  # flags that depend on a repository name

  local REPO="$1"; shift

  if [[ -z "${REPO}" ]]; then
    echo "No repository name specified."
    exit 1
  fi

  if [[ ! -d "${GLOBAL_REPO_DIR}/${REPO}" ]]; then
    echo "The repository ${REPO} does not exist."
    exit 1
  fi

  if [[ ! -z "${flag_Sync}" ]]; then
    sync_with_remote "${REPO}"
  fi

  if [[ ! -z "${flag_add}" ]]; then
    add_package "${REPO}" "${arg_add}"
  fi

  if [[ ! -z "${flag_remove}" ]]; then
    remove_package "${REPO}" "${arg_remove}"
  fi

  if [[ ! -z "${flag_Update}" ]]; then
    update_repository "${REPO}"
  fi

  if [[ ! -z "${flag_build}" ]]; then
    build_package "${REPO}" "${arg_build}"
  fi

  if [[ ! -z "${flag_new_meta_pkg}" ]]; then
    # create_new_meta_package "${REPO}" "${arg_new_meta_pkg}"
    echo
  fi

}

main $@